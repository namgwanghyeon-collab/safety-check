<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>안전장비 검교정 관리</title>
    <!-- 1. Tailwind CSS 로드 (가장 대중적인 CSS 프레임워크 중 하나) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Supabase JS Client 로드 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Supabase/Tailwind를 사용한 안전장비 관리 시스템
         - 기능: CRUD, 이미지 업로드, 정렬, 검색, 년도 필터링, 모바일 반응형
        */
        body {
            font-family: 'Inter', sans-serif;
            color: #000000;
        }
        table thead th {
            background-color: transparent;
        }
        .sort-icon {
            display: inline-block;
            margin-left: 4px;
            opacity: 0.5;
            width: 1rem;
            height: 1rem;
        }
        .sort-icon.active {
            opacity: 1;
        }
        table thead th button {
            margin-left: auto;
            margin-right: auto;
        }

        /* 1. 모바일 반응형(카드 레이아웃)을 위한 CSS 추가 */
        @media (max-width: 767px) { /* Tailwind의 'md' 브레이크포인트(768px) 직전 */
            table thead {
                display: none; /* 모바일에선 헤더 숨김 */
            }
            table tbody {
                display: block;
                width: 100%;
            }
            table tr {
                display: block;
                width: 100%;
                padding: 1rem;
                border: 1px solid #e2e8f0; /* border-gray-200 */
                margin-bottom: 1rem;
                border-radius: 0.5rem; /* rounded-lg */
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow-md */
                background-color: #fff; /* bg-white */
            }
            table td {
                display: block;
                width: 100%;
                /* [수정] 2. 새로운 정렬 방식: 우측/좌측 쏠림 대신 '가운데 정렬' 시도 */
                text-align: center;
                /* [최종 수정] 라벨 35% / 값 65% 비율로 조정 */
                padding-left: 35%; /* 라벨을 위한 공간 확보 (40% -> 35%) */
                position: relative;
                padding-top: 0.25rem;
                padding-bottom: 0.25rem;
                border: none;
                white-space: normal; /* 모바일에서 줄바꿈 허용 */
                font-size: 1rem; 
            }
            table td:before {
                content: attr(data-label); /* JS에서 설정할 data-label 속성값 */
                position: absolute;
                left: 0.5rem; /* p-2 */
                /* [최종 수정] 라벨 35% / 값 65% 비율로 조정 */
                width: calc(35% - 1rem); /* 40% -> 35% 너비로 변경 */
                text-align: left;
                font-weight: 600; /* font-semibold */
                color: #000;
                font-size: 0.875rem; /* 글씨 크기 고정 (base보다 작게) */
            }
            /* '관리' (수정/삭제 버튼) 셀 특별 처리 */
            table td[data-label="관리"] {
                text-align: center;
                padding-left: 0;
                margin-top: 0.5rem;
            }
            table td[data-label="관리"]:before {
                display: none; /* '관리' 라벨은 숨김 */
            }
        }
    </style>
</head>
<body class="bg-white">

    <!-- 모바일 패딩 적용 (p-6 -> p-4 md:p-6) -->
    <div class="container mx-auto p-4 md:p-6">
        <!-- 1. 모바일에서 제목이 밀리지 않도록 폰트 크기 반응형으로 조절 -->
        <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-black text-center">안전장비 검교정 관리 시스템</h1>

        <!-- 모바일: 세로 정렬, 데스크탑: 가로 정렬 -->
        <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            
            <!-- 모바일: 세로 정렬, 데스크탑: 가로 정렬 및 너비 조정 -->
            <div class="flex flex-col md:flex-row md:items-center gap-4 w-full md:w-auto">
                <!-- 5. 검색 기능 추가 -->
                <input type="text" id="searchInput" placeholder="모든 항목 검색..." class="p-2 border border-gray-300 rounded-lg w-full md:w-auto">
                
                <!-- 년도별 검색 드롭다운 -->
                <select id="yearFilter" class="p-2 border border-gray-300 rounded-lg w-full md:w-auto">
                    <option value="">모든 년도 (차기)</option>
                    <!-- 년도는 JS로 동적 추가 -->
                </select>
            </div>
            
            <!-- 4. '+ 신규 장비 추가' 버튼 (우측 정렬) -->
            <button id="addBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 w-full md:w-auto">+ 신규 장비 추가</button>
        </div>

        <!-- 3. 장비 리스트 테이블 (모든 내용 가운데 정렬) -->
        <div class="overflow-x-auto bg-white rounded-lg shadow">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <!-- 8. 모든 항목 정렬 기능 -->
                        <th class="py-3 px-4 text-xs font-bold text-black uppercase tracking-wider text-center">
                            <button data-sort="no" class="flex items-center">
                                NO
                                <span class="sort-icon"></span>
                            </button>
                        </th>
                        <th class="py-3 px-4 text-xs font-bold text-black uppercase tracking-wider text-center">
                            <button data-sort="name" class="flex items-center">
                                장비명
                                <span class="sort-icon"></span>
                            </button>
                        </th>
                        <th class="py-3 px-4 text-xs font-bold text-black uppercase tracking-wider text-center">
                            <button data-sort="equipment_number" class="flex items-center">
                                장비관리번호
                                <span class="sort-icon"></span>
                            </button>
                        </th>
                        <th class="py-3 px-4 text-xs font-bold text-black uppercase tracking-wider text-center">
                            <button data-sort="asset_number" class="flex items-center">
                                자산번호
                                <span class="sort-icon"></span>
                            </button>
                        </th>
                        <th class="py-3 px-4 text-xs font-bold text-black uppercase tracking-wider text-center">
                            <button data-sort="calibration_cycle" class="flex items-center">
                                검교정 주기
                                <span class="sort-icon"></span>
                            </button>
                        </th>
                        <th class="py-3 px-4 text-xs font-bold text-black uppercase tracking-wider text-center">
                            <button data-sort="last_calibration_date" class="flex items-center">
                                검교정일
                                <span class="sort-icon"></span>
                            </button>
                        </th>
                        <th class="py-3 px-4 text-xs font-bold text-black uppercase tracking-wider text-center">
                            <button data-sort="status" class="flex items-center">
                                검교정결과
                                <span class="sort-icon"></span>
                            </button>
                        </th>
                        <th class="py-3 px-4 text-xs font-bold text-black uppercase tracking-wider text-center">
                            <button data-sort="next_calibration_date" class="flex items-center">
                                차기 검교정일
                                <span class="sort-icon"></span>
                            </button>
                        </th>
                        <th class="py-3 px-4 text-xs font-bold text-black uppercase tracking-wider text-center">
                            관리
                        </th>
                    </tr>
                </thead>
                <!-- JS로 채워질 테이블 본문 -->
                <tbody id="equipmentTableBody" class="divide-y divide-gray-200">
                    <!-- 로딩 스피너 또는 데이터 없음 메시지 -->
                    <tr>
                        <td colspan="9" class="py-4 px-4 text-center text-gray-500">
                            데이터를 불러오는 중입니다...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 1. '새 장비 등록' 및 '수정'을 위한 모달 (Modal) -->
    <div id="formModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-lg bg-white">
            <div class="mt-3 text-center">
                <!-- 2. 글자 밀림 방지를 위해 제목 영역 너비 고정 -->
                <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900 w-full">새 장비 등록</h3>
                <form id="equipmentForm" class="mt-2 space-y-4">
                    <!-- 숨겨진 ID 필드 (수정 시 사용) -->
                    <input type="hidden" id="equipmentId">
                    
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 text-left">장비명 *</label>
                        <input type="text" id="name" class="mt-1 p-2 w-full border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="equipment_number" class="block text-sm font-medium text-gray-700 text-left">장비관리번호</label>
                        <input type="text" id="equipment_number" class="mt-1 p-2 w-full border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="asset_number" class="block text-sm font-medium text-gray-700 text-left">자산번호</label>
                        <input type="text" id="asset_number" class="mt-1 p-2 w-full border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="calibration_cycle" class="block text-sm font-medium text-gray-700 text-left">검교정 주기</label>
                        <input type="text" id="calibration_cycle" class="mt-1 p-2 w-full border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="last_calibration_date" class="block text-sm font-medium text-gray-700 text-left">최근 검교정일</label>
                        <input type="date" id="last_calibration_date" class="mt-1 p-2 w-full border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 text-left">검교정 상태 *</label>
                        <select id="status" class="mt-1 p-2 w-full border border-gray-300 rounded-lg" required>
                            <option value="적합">적합</option>
                            <option value="부적합">부적합</option>
                        </select>
                    </div>
                    <div>
                        <label for="next_calibration_date" class="block text-sm font-medium text-gray-700 text-left">차기 검교정일</label>
                        <input type="date" id="next_calibration_date" class="mt-1 p-2 w-full border border-gray-300 rounded-lg">
                    </div>
                    
                    <!-- 버튼 영역 -->
                    <div class="items-center gap-4 py-3 flex justify-end">
                        <button id="cancelBtn" type="button" class="p-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            취소
                        </button>
                        <button id="saveBtn" type="submit" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            저장
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 2. '삭제' 확인 모달 -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden">
        <div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-lg bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">삭제 확인</h3>
                <!-- [수정] 2. 삭제 안내 문구 수정 -->
                <p class="mt-2 text-sm text-gray-600">삭제를 원하신다면 비밀번호를 넣어주세요.</p>
                <input type="password" id="deletePassword" class="mt-4 p-2 w-full border border-gray-300 rounded-lg" placeholder="비밀번호 0000">
                <div class="items-center gap-4 py-3 flex justify-end">
                    <button id="cancelDeleteBtn" class="p-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                        취소
                    </button>
                    <button id="confirmDeleteBtn" class="p-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        삭제
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. '사진 업로드' 모달 -->
    <div id="imageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-lg bg-white">
            <div class="mt-3 text-center">
                <h3 id="imageModalTitle" class="text-lg leading-6 font-medium text-gray-900">장비 사진 관리</h3>
                <input type="hidden" id="imageEquipmentId">
                
                <!-- 현재 이미지 표시 -->
                <div class="mt-4">
                    <img id="currentImage" src="https://placehold.co/400x300/e2e8f0/a0aec0?text=No+Image" alt="장비 사진" class="w-full h-auto max-h-60 object-contain rounded-lg border border-gray-200">
                    <button id="removeImageBtn" class="mt-2 text-sm text-red-600 hover:underline hidden">사진 삭제</button>
                </div>

                <!-- 새 이미지 업로드 -->
                <form id="imageUploadForm" class="mt-4 space-y-3">
                    <div>
                        <label for="imageFile" class="block text-sm font-medium text-gray-700 text-left">새 사진 업로드 (JPG, PNG)</label>
                        <input type="file" id="imageFile" accept="image/png, image/jpeg" class="mt-1 block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-lg file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100
                        ">
                    </div>
                    
                    <div class="items-center gap-4 py-3 flex justify-end">
                        <button id="cancelImageBtn" type="button" class="p-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            닫기
                        </button>
                        <button id="saveImageBtn" type="submit" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            사진 저장
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 메시지 알림 (Alert) -->
    <div id="alertBox" class="fixed bottom-5 right-5 p-4 rounded-lg shadow-lg hidden max-w-sm">
        <span id="alertMessage"></span>
    </div>


    <script type="module">
        // 1. Supabase 클라이언트 초기화
        // Supabase 설정 가이드:
        // 1. Supabase 프로젝트 생성
        // 2. 이 코드를 복사하여 `index.html`로 저장
        // 3. 아래 SUPABASE_URL과 SUPABASE_ANON_KEY를 본인의 프로젝트 값으로 변경
        // 4. Supabase 'Table Editor' > 'New table'
        //    - 이름: equipment
        //    - 열 추가 (타입은 Supabase에 맞게): 
        //      - name (text)
        //      - equipment_number (text, nullable)
        //      - asset_number (text, nullable)
        //      - calibration_cycle (text, nullable) [수정됨]
        //      - status (text)
        //      - last_calibration_date (date, nullable)
        //      - next_calibration_date (date, nullable)
        //      - image_url (text, nullable)
        // 5. 'Storage' > 'New bucket'
        //    - 이름: equipment-images
        //    - 'Public' 체크
        // 6. 'Authentication' > 'Policies' > `equipment` 테이블의 RLS를 'Disable RLS'로 설정 (테스트용)
        
        const SUPABASE_URL = 'https://bfoutvupvqadnrpbgagj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmb3V0dnVwdnFhZG5ycGJnYWdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTQ5NDMsImV4cCI6MjA3ODI3MDk0M30.u9B0HJZo1TKypF6df-EvYLYb_xT1dlufFIpMKoXaN7M';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 전역 변수 (데이터 캐시 및 상태 관리)
        let equipmentData = [];
        let currentSort = { column: 'created_at', order: 'desc' }; // 기본 정렬

        // DOM 요소
        const tableBody = document.getElementById('equipmentTableBody');
        const searchInput = document.getElementById('searchInput');
        const yearFilter = document.getElementById('yearFilter');
        
        // 모달 및 폼 요소
        const formModal = document.getElementById('formModal');
        const modalTitle = document.getElementById('modalTitle');
        const equipmentForm = document.getElementById('equipmentForm');
        const equipmentIdInput = document.getElementById('equipmentId');
        
        const deleteModal = document.getElementById('deleteModal');
        const deletePasswordInput = document.getElementById('deletePassword');
        let deleteTargetId = null;

        const imageModal = document.getElementById('imageModal');
        const imageModalTitle = document.getElementById('imageModalTitle');
        const imageEquipmentIdInput = document.getElementById('imageEquipmentId');
        const currentImage = document.getElementById('currentImage');
        const imageUploadForm = document.getElementById('imageUploadForm');
        const imageFileEl = document.getElementById('imageFile');
        const removeImageBtn = document.getElementById('removeImageBtn');

        // 알림창 요소
        const alertBox = document.getElementById('alertBox');
        const alertMessage = document.getElementById('alertMessage');
        
        // 2. 데이터 렌더링 (테이블 그리기)
        
        /**
         * 7. 차기 검교정일이 1개월 이내면 빨간색 굵은 글씨
         */
        function getNextDateClass(dateStr) {
            if (!dateStr) return '';
            
            const nextDate = new Date(dateStr);
            const today = new Date();
            const oneMonthLater = new Date(today.setMonth(today.getMonth() + 1));
            
            // 2. 글자 밀림 방지: font-bold 대신 font-semibold 사용
            if (nextDate <= oneMonthLater) {
                return 'text-red-700 font-semibold'; // 굵은 글씨 (굵기 약간 낮춤)
            }
            return '';
        }

        /**
         * 테이블 렌더링 함수
         */
        function renderTable() {
            if (!tableBody) return;

            const searchTerm = searchInput.value.toLowerCase();
            const selectedYear = yearFilter.value;

            // 1. 검색 기능 (모든 항목 대상)
            const filteredData = equipmentData.filter(item => {
                const matchesSearch = (
                    (item.name?.toLowerCase() || '').includes(searchTerm) ||
                    (item.equipment_number?.toLowerCase() || '').includes(searchTerm) ||
                    (item.asset_number?.toLowerCase() || '').includes(searchTerm) ||
                    (item.calibration_cycle?.toLowerCase() || '').includes(searchTerm) ||
                    (item.status?.toLowerCase() || '').includes(searchTerm) ||
                    (item.last_calibration_date?.toLowerCase() || '').includes(searchTerm) ||
                    (item.next_calibration_date?.toLowerCase() || '').includes(searchTerm)
                );
                
                // 2. 년도 필터링
                const matchesYear = (
                    !selectedYear || // '모든 년도' 선택
                    (item.next_calibration_date && item.next_calibration_date.startsWith(selectedYear))
                );
                
                return matchesSearch && matchesYear;
            });

            // 2. 정렬 기능
            const sortedData = filteredData.sort((a, b) => {
                let aVal = a[currentSort.column];
                let bVal = b[currentSort.column];

                if (currentSort.column === 'no') {
                    aVal = filteredData.indexOf(a);
                    bVal = filteredData.indexOf(b);
                }

                if (aVal === null || aVal === undefined) aVal = '';
                if (bVal === null || bVal === undefined) bVal = '';

                let result = 0;
                if (aVal < bVal) result = -1;
                else if (aVal > bVal) result = 1;
                
                return currentSort.order === 'asc' ? result : -result;
            });
            
            tableBody.innerHTML = ''; // 테이블 비우기

            if (sortedData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="py-4 px-4 text-center text-gray-500">표시할 데이터가 없습니다.</td></tr>`;
                return;
            }

            // [원상복구] 1. 모바일 색상 원상복구 (흑백)
            sortedData.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50'; // 데스크탑용 호버 효과
                
                const nextDateClass = getNextDateClass(item.next_calibration_date);
                
                // [원상복구] '적합'/'부적합' 색상을 다시 흑백(검정)으로 변경
                const statusClass = item.status === '적합' ? 'text-black' : (item.status === '부적합' ? 'text-black' : 'text-black');

                // [중요] 모바일 반응형을 위해 data-label 속성 추가
                tr.innerHTML = `
                    <td class="py-3 px-4 text-sm text-black text-center" data-label="NO">${index + 1}</td>
                    <td class="py-3 px-4 text-sm text-black text-center" data-label="장비명">
                        <!-- 5. 장비명 클릭 시 사진 업로드 -->
                        <a href="#" class="text-blue-600 hover:underline" data-id="${item.id}" data-action="image">
                            ${item.name}
                        </a>
                    </td>
                    <td class="py-3 px-4 text-sm text-black text-center" data-label="장비관리번호">${item.equipment_number || ''}</td>
                    <td class="py-3 px-4 text-sm text-black text-center" data-label="자산번호">${item.asset_number || ''}</td>
                    <td class="py-3 px-4 text-sm text-black text-center" data-label="검교정 주기">${item.calibration_cycle || ''}</td>
                    <td class="py-3 px-4 text-sm text-black text-center" data-label="검교정일">${item.last_calibration_date || ''}</td>
                    <td class="py-3 px-4 text-sm text-black text-center" data-label="검교정결과">
                        <span class="text-sm font-semibold ${statusClass}">
                            ${item.status}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-sm text-black text-center ${nextDateClass}" data-label="차기 검교정일">${item.next_calibration_date || ''}</td>
                    <td class="py-3 px-4 text-sm text-center" data-label="관리">
                        <!-- 4. 수정/삭제 버튼 -->
                        <button class="text-green-600 hover:text-green-800" data-id="${item.id}" data-action="edit">수정</button>
                        <button class="ml-2 text-red-600 hover:text-red-800" data-id="${item.id}" data-action="delete">삭제</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }
        
        /**
         * 년도 필터 옵션 채우기
         */
        function populateYearFilter() {
            const years = new Set(
                equipmentData
                    .map(item => item.next_calibration_date ? item.next_calibration_date.substring(0, 4) : null)
                    .filter(year => year) // null 제거
            );
            
            // 현재 년도 옵션을 제외하고 모두 제거 (중복 방지)
            while (yearFilter.options.length > 1) {
                yearFilter.remove(1);
            }
            
            // 정렬된 년도 추가
            [...years].sort().forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}년`;
                yearFilter.appendChild(option);
            });
        }

        // 3. 데이터 로드 (Fetch)
        async function fetchEquipment() {
            try {
                const { data, error } = await db
                    .from('equipment')
                    .select('*')
                    .order('created_at', { ascending: false }); // 기본 정렬

                if (error) throw error;
                
                equipmentData = data;
                renderTable();
                populateYearFilter(); // 데이터 로드 후 년도 필터 채우기
            } catch (error) {
                console.error('데이터 로드 오류:', error);
                showNotification(`데이터 로드 실패: ${error.message}`, 'error');
                if (tableBody) tableBody.innerHTML = `<tr><td colspan="9" class="py-4 px-4 text-center text-red-500">데이터 로드에 실패했습니다. Supabase 연결을 확인하세요.</td></tr>`;
            }
        }

        // 4. 모달 관리
        
        // 폼 모달 열기 (새 장비)
        function openAddModal() {
            formModal.classList.remove('hidden');
            modalTitle.textContent = '새 장비 등록';
            equipmentForm.reset();
            equipmentIdInput.value = '';
        }

        // 폼 모달 열기 (수정)
        function openEditModal(id) {
            // [버그 수정] 3. 수정 버튼 (e.id == id)
            // 문자열 ID와 숫자 ID를 비교하기 위해 '===' 대신 '==' 사용
            const item = equipmentData.find(e => e.id == id);
            if (!item) {
                console.error('수정할 항목을 찾을 수 없습니다.');
                return;
            }
            
            formModal.classList.remove('hidden');
            modalTitle.textContent = '장비 정보 수정';
            
            equipmentIdInput.value = item.id;
            document.getElementById('name').value = item.name;
            document.getElementById('equipment_number').value = item.equipment_number || '';
            document.getElementById('asset_number').value = item.asset_number || '';
            document.getElementById('calibration_cycle').value = item.calibration_cycle || '';
            document.getElementById('last_calibration_date').value = item.last_calibration_date || '';
            document.getElementById('status').value = item.status;
            document.getElementById('next_calibration_date').value = item.next_calibration_date || '';
        }

        // 폼 모달 닫기
        function closeFormModal() {
            formModal.classList.add('hidden');
        }

        // 삭제 모달 열기
        function openDeleteModal(id) {
            deleteTargetId = id;
            deleteModal.classList.remove('hidden');
            deletePasswordInput.value = ''; // 비밀번호 필드 초기화
        }

        // 삭제 모달 닫기
        function closeDeleteModal() {
            deleteModal.classList.add('hidden');
            deleteTargetId = null;
        }
        
        // 이미지 모달 열기
        function openImageModal(id) {
            // [버그 수정] 4. 장비명 링크 (e.id == id)
            const item = equipmentData.find(e => e.id == id);
            if (!item) {
                console.error('항목을 찾을 수 없습니다.');
                return;
            }
            
            imageModal.classList.remove('hidden');
            imageModalTitle.textContent = `${item.name} (사진 관리)`;
            imageEquipmentIdInput.value = item.id;
            imageUploadForm.reset();
            
            // 기존 이미지 표시
            if (item.image_url) {
                // Supabase 스토리지에서 이미지 URL 가져오기
                const { data } = db.storage.from('equipment-images').getPublicUrl(item.image_url);
                currentImage.src = data.publicUrl + `?t=${new Date().getTime()}`; // 캐시 방지
                currentImage.onerror = () => { currentImage.src = 'https://placehold.co/400x300/e2e8f0/a0aec0?text=Image+Not+Found'; };
                removeImageBtn.classList.remove('hidden');
            } else {
                currentImage.src = 'https://placehold.co/400x300/e2e8f0/a0aec0?text=No+Image';
                removeImageBtn.classList.add('hidden');
            }
        }
        
        // 이미지 모달 닫기
        function closeImageModal() {
            imageModal.classList.add('hidden');
        }

        // 5. 데이터 처리 (CRUD)
        
        // 저장 (생성/수정)
        async function handleSave(e) {
            e.preventDefault();
            
            const id = equipmentIdInput.value;
            const equipment = {
                name: document.getElementById('name').value,
                equipment_number: document.getElementById('equipment_number').value || null,
                asset_number: document.getElementById('asset_number').value || null,
                calibration_cycle: document.getElementById('calibration_cycle').value || null,
                status: document.getElementById('status').value,
                last_calibration_date: document.getElementById('last_calibration_date').value || null,
                next_calibration_date: document.getElementById('next_calibration_date').value || null,
            };

            try {
                let error;
                if (id) {
                    // 수정 (Update)
                    const { error: updateError } = await db
                        .from('equipment')
                        .update(equipment)
                        .eq('id', id);
                    error = updateError;
                } else {
                    // 생성 (Insert)
                    const { error: insertError } = await db
                        .from('equipment')
                        .insert([equipment]);
                    error = insertError;
                }
                
                if (error) throw error;
                
                closeFormModal();
                showNotification(id ? '장비 정보가 수정되었습니다.' : '새 장비가 등록되었습니다.', 'success');
                await fetchEquipment(); // 데이터 새로고침
                
            } catch (error) {
                console.error('저장 오류:', error);
                showNotification(`저장 실패: ${error.message}`, 'error');
            }
        }

        // 삭제
        async function handleDelete() {
            if (deletePasswordInput.value !== '0000') {
                showNotification('비밀번호가 올바르지 않습니다.', 'error');
                return;
            }
            
            if (!deleteTargetId) return;

            try {
                // (선택 사항) 관련 이미지가 있다면 스토리지에서 먼저 삭제
                const item = equipmentData.find(e => e.id == deleteTargetId);
                if (item && item.image_url) {
                    await db.storage.from('equipment-images').remove([item.image_url]);
                }
                
                // 데이터베이스에서 삭제
                const { error } = await db
                    .from('equipment')
                    .delete()
                    .eq('id', deleteTargetId);
                    
                if (error) throw error;
                
                closeDeleteModal();
                showNotification('장비가 삭제되었습니다.', 'success');
                await fetchEquipment(); // 데이터 새로고침

            } catch (error) {
                console.error('삭제 오류:', error);
                showNotification(`삭제 실패: ${error.message}`, 'error');
            }
        }
        
        // 이미지 저장
        async function handleImageSave(e) {
            e.preventDefault();
            
            const id = imageEquipmentIdInput.value;
            const file = imageFileEl.files[0];
            
            if (!file) {
                showNotification('업로드할 파일을 선택하세요.', 'error');
                return;
            }
            
            // 파일 경로 (예: 'public/123-filename.png')
            const filePath = `public/${id}-${Date.now()}-${file.name}`;
            
            try {
                // 1. 스토리지에 업로드
                const { error: uploadError } = await db.storage
                    .from('equipment-images')
                    .upload(filePath, file);
                
                if (uploadError) throw uploadError;
                
                // 2. equipment 테이블에 image_url 업데이트
                const { error: updateError } = await db
                    .from('equipment')
                    .update({ image_url: filePath })
                    .eq('id', id);
                    
                if (updateError) throw updateError;
                
                closeImageModal();
                showNotification('사진이 업로드되었습니다.', 'success');
                await fetchEquipment(); // 데이터 새로고침
                
            } catch (error) {
                console.error('사진 업로드 오류:', error);
                showNotification(`사진 업로드 실패: ${error.message}`, 'error');
            }
        }
        
        // 이미지 삭제
        async function handleImageRemove() {
            const id = imageEquipmentIdInput.value;
            const item = equipmentData.find(e => e.id == id);
            
            if (!item || !item.image_url) {
                showNotification('삭제할 이미지가 없습니다.', 'error');
                return;
            }

            try {
                // 1. 스토리지에서 삭제
                const { error: removeError } = await db.storage
                    .from('equipment-images')
                    .remove([item.image_url]);
                
                if (removeError) throw removeError;
                
                // 2. 테이블에서 image_url 제거 (null로 설정)
                const { error: updateError } = await db
                    .from('equipment')
                    .update({ image_url: null })
                    .eq('id', id);
                
                if (updateError) throw updateError;
                
                closeImageModal();
                showNotification('사진이 삭제되었습니다.', 'success');
                await fetchEquipment(); // 데이터 새로고침

            } catch (error) {
                console.error('사진 삭제 오류:', error);
                showNotification(`사진 삭제 실패: ${error.message}`, 'error');
            }
        }

        // 6. 알림창 (Toast)
        function showNotification(message, type = 'success') {
            alertMessage.textContent = message;
            
            if (type === 'error') {
                alertBox.className = 'fixed bottom-5 right-5 p-4 rounded-lg shadow-lg bg-red-600 text-white max-w-sm';
            } else {
                alertBox.className = 'fixed bottom-5 right-5 p-4 rounded-lg shadow-lg bg-green-600 text-white max-w-sm';
            }
            
            alertBox.classList.remove('hidden');
            
            // 3초 후에 자동으로 사라짐
            setTimeout(() => {
                alertBox.classList.add('hidden');
            }, 3000);
        }

        // 7. 이벤트 리스너
        
        // [수정] 3. 클릭 오류 해결: DOMContentLoaded 사용
        // HTML 문서가 완전히 로드된 후에만 이벤트 리스너를 추가합니다.
        document.addEventListener('DOMContentLoaded', () => {

            // '+ 신규 장비 추가' 버튼
            document.getElementById('addBtn')?.addEventListener('click', openAddModal);

            // 폼 모달 '취소' 버튼
            document.getElementById('cancelBtn')?.addEventListener('click', closeFormModal);
            
            // 폼 '저장' 버튼
            equipmentForm?.addEventListener('submit', handleSave);

            // 삭제 모달 '취소' 버튼
            document.getElementById('cancelDeleteBtn')?.addEventListener('click', closeDeleteModal);

            // 삭제 모달 '삭제' 버튼
            document.getElementById('confirmDeleteBtn')?.addEventListener('click', handleDelete);
            
            // 이미지 모달 '닫기' 버튼
            document.getElementById('cancelImageBtn')?.addEventListener('click', closeImageModal);
            
            // 이미지 모달 '사진 저장' 버튼
            imageUploadForm?.addEventListener('submit', handleImageSave);
            
            // 이미지 모달 '사진 삭제' 버튼
            removeImageBtn?.addEventListener('click', handleImageRemove);
            
            // 검색 입력
            searchInput?.addEventListener('input', renderTable);
            
            // 년도 필터 변경
            yearFilter?.addEventListener('change', renderTable);

            // 테이블 클릭 이벤트 위임 (수정/삭제/이미지)
            tableBody?.addEventListener('click', (e) => {
                const target = e.target.closest('button') || e.target.closest('a');
                if (!target) return;
                
                const id = target.dataset.id;
                const action = target.dataset.action;

                if (action === 'edit') {
                    openEditModal(id);
                } else if (action === 'delete') {
                    openDeleteModal(id);
                } else if (action === 'image') {
                    e.preventDefault(); // 링크 기본 동작(페이지 이동) 방지
                    openImageModal(id);
                }
            });
            
            // 정렬 버튼 클릭
            document.querySelector('thead')?.addEventListener('click', (e) => {
                const button = e.target.closest('button[data-sort]');
                if (!button) return;

                const column = button.dataset.sort;
                
                // 아이콘 초기화
                document.querySelectorAll('span.sort-icon').forEach(icon => {
                    icon.classList.remove('active');
                    icon.innerHTML = ''; // 아이콘 비우기
                });

                if (currentSort.column === column) {
                    currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.order = 'asc';
                }
                
                // 활성 아이콘 설정
                const iconSpan = button.querySelector('span.sort-icon');
                iconSpan.classList.add('active');
                iconSpan.innerHTML = currentSort.order === 'asc' ? '&#9650;' : '&#9660;'; // 위/아래 화살표

                renderTable();
            });

            // 초기 데이터 로드
            fetchEquipment();
        });
        
    </script>
</body>
</html>
